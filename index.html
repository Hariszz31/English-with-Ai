    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>AI English Tutor</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
            body {
                font-family: 'Inter', sans-serif;
                background-color: #f3f4f6;
                color: #1f2937;
            }
            .chat-message {
                border-radius: 1rem;
                padding: 1rem;
                margin-bottom: 0.75rem;
                max-width: 80%;
            }
            .user-message {
                background-color: #3b82f6;
                color: #ffffff;
                margin-left: auto;
            }
            .ai-message {
                background-color: #e5e7eb;
                color: #1f2937;
                margin-right: auto;
            }
            .send-button {
                transition: background-color 0.3s ease;
            }
            .send-button:hover {
                background-color: #2563eb;
            }
            .loading-dots::after {
                content: '...';
                animation: dots 1.5s linear infinite;
            }
            @keyframes dots {
                0% { content: '.'; }
                33% { content: '..'; }
                66% { content: '...'; }
            }
        </style>
    </head>
    <body class="flex flex-col h-screen p-4 bg-gray-100">
        <div class="flex-1 flex flex-col overflow-hidden bg-white rounded-2xl shadow-xl">
            <header class="p-4 bg-teal-500 text-white rounded-t-2xl shadow-md">
                <h1 class="text-2xl font-bold">AI English Tutor</h1>
            </header>
            
            <!-- Chat display area -->
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4">
                <!-- Initial message from AI -->
                <div class="chat-message ai-message">
                    Hello! I'm your AI English tutor. I'm here to help you practice your speaking skills. How is your day going?
                </div>
            </div>
            
            <!-- Input and controls area -->
            <div class="p-4 bg-gray-200 rounded-b-2xl flex items-center space-x-3">
                <button id="record-button" class="flex-shrink-0 p-3 bg-red-500 text-white rounded-full shadow-lg hover:bg-red-600 transition-colors duration-200 focus:outline-none focus:ring-4 focus:ring-red-300">
                    <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a4 4 0 110-8 4 4 0 010 8z" />
                    </svg>
                    <svg id="stop-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 10h6m-3-3v6m-3 3H8m4-4h4" />
                    </svg>
                </button>
                <div id="status-message" class="flex-grow text-gray-500 italic">Press the microphone to speak.</div>
            </div>
        </div>

        <script>
            // ====================================================================
            // Configuration and API Key
            // ====================================================================

            // You must get a free API key from Google AI Studio.
            // Find the "Get API key" button at the top right of the website.
            // This is required for the AI to work.
            const API_KEY = "AIzaSyB-llFizT4Hvvl8Jnq1R6CSZZk_hwsy7GE";
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
            
            const chatHistory = [
                { role: "user", parts: [{ text: "You are a friendly English tutor. Your goal is to help me practice my English speaking skills. You should respond with a natural, conversational tone and only use voice. Do not include any text in your responses. Keep the conversation flowing and correct my mistakes in a gentle, encouraging way. Let's start with a casual conversation. You can start by asking me how my day is going." }] },
                { role: "model", parts: [{ text: "Hello! I'm your AI English tutor. I'm here to help you practice your speaking skills. How is your day going?" }] }
            ];
            
            // ====================================================================
            // DOM Elements and State
            // ====================================================================

            const recordButton = document.getElementById('record-button');
            const micIcon = document.getElementById('mic-icon');
            const stopIcon = document.getElementById('stop-icon');
            const statusMessage = document.getElementById('status-message');
            const chatContainer = document.getElementById('chat-container');

            let isRecording = false;
            let recognition;
            let audioContext;
            let audioSource;
            let audioData = [];
            let isSpeaking = false;

            // ====================================================================
            // Speech-to-Text (STT) - Uses Web Speech API
            // ====================================================================

            if (window.SpeechRecognition || window.webkitSpeechRecognition) {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onstart = () => {
                    isRecording = true;
                    micIcon.classList.add('hidden');
                    stopIcon.classList.remove('hidden');
                    statusMessage.textContent = "Listening...";
                };

                recognition.onend = () => {
                    isRecording = false;
                    micIcon.classList.remove('hidden');
                    stopIcon.classList.add('hidden');
                    if (audioData.length === 0) {
                        statusMessage.textContent = "Press the microphone to speak.";
                    }
                    if (audioData.length > 0) {
                        processAudio();
                    }
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    if (transcript && transcript.trim() !== '') {
                        addMessageToChat(transcript, 'user');
                        sendToAI(transcript);
                    }
                };
            } else {
                statusMessage.textContent = "Speech recognition not supported in this browser.";
                recordButton.disabled = true;
            }

            recordButton.addEventListener('click', () => {
                if (isRecording) {
                    recognition.stop();
                } else {
                    recognition.start();
                }
            });

            // ====================================================================
            // Text-to-Speech (TTS) - Uses SpeechSynthesis API
            // ====================================================================

            function speak(text) {
                if (isSpeaking) {
                    window.speechSynthesis.cancel();
                }

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.onstart = () => {
                    isSpeaking = true;
                    statusMessage.textContent = "AI is speaking...";
                };
                utterance.onend = () => {
                    isSpeaking = false;
                    statusMessage.textContent = "Press the microphone to speak.";
                };
                window.speechSynthesis.speak(utterance);
            }

            // ====================================================================
            // Gemini AI Integration
            // ====================================================================
            
            function addMessageToChat(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
                messageDiv.textContent = text;
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            async function sendToAI(prompt) {
                statusMessage.textContent = "AI is thinking...";

                try {
                    const chatHistory = getChatHistory();
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                    const payload = {
                        contents: chatHistory,
                    };

                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const aiText = result.candidates[0].content.parts[0].text;
                        addMessageToChat(aiText, 'ai');
                        speak(aiText);
                        updateChatHistory(prompt, aiText);
                    } else {
                        throw new Error('Unexpected API response structure.');
                    }
                } catch (e) {
                    console.error('Error from AI:', e);
                    addMessageToChat("Sorry, I am having trouble. Please try again.", 'ai');
                    speak("Sorry, I am having trouble. Please try again.");
                }
            }

            // ====================================================================
            // Helper Functions
            // ====================================================================

            function getChatHistory() {
                // Return a copy to avoid modifying the original array
                return JSON.parse(localStorage.getItem('chatHistory') || JSON.stringify(chatHistory));
            }

            function updateChatHistory(userText, aiText) {
                const currentHistory = getChatHistory();
                currentHistory.push({ role: "user", parts: [{ text: userText }] });
                currentHistory.push({ role: "model", parts: [{ text: aiText }] });
                localStorage.setItem('chatHistory', JSON.stringify(currentHistory));
            }

            function initializeChat() {
                 if (localStorage.getItem('chatHistory')) {
                     const storedHistory = JSON.parse(localStorage.getItem('chatHistory'));
                     if (storedHistory.length > 2) {
                        storedHistory.forEach(message => {
                            if (message.role === 'user') {
                                addMessageToChat(message.parts[0].text, 'user');
                            } else if (message.role === 'model') {
                                addMessageToChat(message.parts[0].text, 'ai');
                            }
                        });
                     }
                 }
            }

            window.onload = initializeChat;

        </script>
    </body>
    </html>
    